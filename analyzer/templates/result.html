{% extends "base.html" %}

{% block content %}
<section class="result-container">
  <div class="card">
    <h2>Hasil Analisis PyMatch</h2>
    <p class="result-desc">
      Berikut hasil analisis kemiripan kode Python berdasarkan metode 
      <strong>AST (Abstract Syntax Tree)</strong>.
    </p>

    <!-- ==========================
         UNDUH FILE HASIL (TXT/XLSX/CSV)
    =========================== -->
    <h3>Unduh File Hasil</h3>
    <div class="download-buttons">
      {% for f in files %}
        {% if not ".png" in f.filename %}
        <div class="download-item">
          <a href="{% url 'download_result' f.job_id f.filename %}"
             class="btn-download" download>
            {{ f.label }}
          </a>

          {# === PREVIEW TXT: blok kode mirip === #}
          {% if ".txt" in f.filename %}
            <p class="download-desc">
              Berisi ringkasan pasangan file dan potongan blok kode Python
              yang terdeteksi mirip. Cocok untuk menelusuri indikasi plagiarisme
              per fungsi, loop, atau percabangan.
            </p>

            {% if preview.txt %}
              <div class="preview-box">
                <pre>
{% for line in preview.txt %}{{ line }}
{% endfor %}
                </pre>
                <span style="font-style:italic; font-size:11px;">
                  (Cuplikan sebagian isi. Lihat file TXT untuk detail lengkap.)
                </span>
              </div>
            {% endif %}

          {# === PREVIEW XLSX: ringkasan ukuran matriks === #}
          {% elif ".xlsx" in f.filename %}
            <p class="download-desc">
              Berisi blok-blok kode mirip dalam format Excel sehingga dapat
              difilter, diurutkan, dan dianalisis lebih lanjut (misalnya per
              pasangan mahasiswa atau jenis blok kode).
            </p>

            <div class="preview-box">
              {{ preview.xlsx }}
            </div>

          {# === PREVIEW CSV: contoh pasangan similarity tertinggi === #}
          {% elif ".csv" in f.filename %}
            <p class="download-desc">
              Berisi matriks nilai similaritas antar semua file program dalam
              format CSV. Dapat dibuka di Excel/Spreadsheet untuk analisis lanjutan.
            </p>

            {% if preview.csv_pairs %}
              <div class="preview-box">
                <strong>Contoh pasangan similarity tertinggi:</strong><br>
                {% for p in preview.csv_pairs %}
                  • {{ p.file_a }} vs {{ p.file_b }} → {{ p.score|floatformat:2 }}<br>
                {% endfor %}
                <span style="font-style:italic; font-size:11px;">
                  (Lihat file CSV dan matriks di bawah untuk daftar lengkap.)
                </span>
              </div>
            {% endif %}

          {% endif %}
        </div>
        {% endif %}
      {% endfor %}
    </div>

    <hr>

    <!-- ==========================
         HEATMAP SIMILARITAS
    =========================== -->
    <h3>Heatmap Similaritas</h3>
    {% for f in files %}
      {% if ".png" in f.filename %}
        <div class="heatmap-box">
          <img src="{% url 'download_result' f.job_id f.filename %}"
               alt="Heatmap Similaritas"
               class="heatmap-img">
        </div>

        <div style="margin-top:12px;">
          <a href="{% url 'download_result' f.job_id f.filename %}"
             class="btn-download" download>
            Unduh Heatmap (PNG)
          </a>
        </div>
      {% endif %}
    {% endfor %}

    <hr>

    <!-- ==========================
         MATRIKS SIMILARITAS
    =========================== -->
    <h3>Matriks Similaritas</h3>
    <div class="matrix-table">
      {{ matrix|safe }}
    </div>


    <!-- ==========================
        TIER / REKOMENDASI BERDASARKAN THRESHOLD
    =========================== -->
    <hr>
    <h3>Rekomendasi Tingkat Kemiripan</h3>

    <div class="tier-header" style="margin-bottom:10px;">
      <strong>Threshold saat ini:</strong> {{ threshold|floatformat:2 }}
      <p style="font-size:13px; color:#555; margin-top:6px;">
        Nilai kemiripan di bawah threshold dikategorikan sebagai <strong>Rendah</strong>.
        Nilai di atas threshold dibagi menjadi <strong>Sedang</strong> dan <strong>Tinggi</strong>.
      </p>
    </div>

    <div class="tier-legend" style="margin-bottom:12px;">
      <span class="badge badge-low">Rendah (&lt; {{ threshold|floatformat:2 }})</span>
      <span class="badge badge-mid">
        Sedang ({{ threshold|floatformat:2 }} – {{ threshold|add:"0.125"|floatformat:2 }})
      </span>
      <span class="badge badge-high">
        Tinggi (≥ {{ threshold|add:"0.125"|floatformat:2 }})
      </span>
    </div>


    <table class="table table-striped" style="width:100%; margin-top:12px;">
      <thead>
        <tr>
          <th>File A</th>
          <th>File B</th>
          <th style="width:110px;">Score</th>
          <th style="width:120px;">Tingkat</th>
        </tr>
      </thead>
      <tbody>
        {% for p in display_pairs %}
          <tr>
            <td>{{ p.file_a }}</td>
            <td>{{ p.file_b }}</td>
            <td>{{ p.score|floatformat:2 }}</td>
            <td><span class="badge {{ p.tier_class }}">{{ p.tier_label }}</span></td>
          </tr>
        {% empty %}
          <tr><td colspan="5">Tidak ada pasangan untuk ditampilkan.</td></tr>
        {% endfor %}
      </tbody>
    </table>


    <div style="margin-top:30px;">
      <a href="{% url 'index' %}" class="btn-back">
        Kembali ke Halaman Utama
      </a>
    </div>
  </div>
</section>
{% endblock %}
